<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="<%= BASE_URL %>favicon.ico">
    <title><%= htmlWebpackPlugin.options.title %></title>
  </head>
  <body>
    <noscript>
      <strong>We're sorry but <%= htmlWebpackPlugin.options.title %> doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app"></div>
    <!-- built files will be auto injected -->
    <script>
      var pyodideWorker = new Worker('<%= BASE_URL %>webworker.js');
      /*pyodideWorker.onerror = (e) => {
        console.log(`Error in pyodideWorker: ` + JSON.stringify(e));
      }*/

      pyodideWorker.onmessage = (e) => {
        /*const {results, error} = e.data
        if (results) {
          console.log('pyodideWorker return results: ', results)
        } else if (error) {
          console.log('pyodideWorker error: ', error)
        }*/

        languagePluginLoader.then(() => {
          self.pyodide.loadPackage(['numpy', 'pytz', 'pandas']).then(() => {
            const data = e.data;
            const keys = Object.keys(data);
            for (let key of keys) {
              if (key !== 'python') {
                // Keys other than python must be arguments for the python script.
                // Set them on self, so that `from js import key` works.
                self[key] = data[key];
              }
            }
            self.pyodide.runPythonAsync(data.python, () => {})
              .then((results) => { self.postMessage({results}); })
              .catch((err) => {
                // if you prefer messages with the error
                self.postMessage({error : err.message});
                // if you prefer onerror events
                // setTimeout(() => { throw err; });
              });
          });
        });
      };

      data = {
        python:
          'import pandas as pd \n'
      }
      pyodideWorker.postMessage(data);

      /*
        We need to load Pyodide after everything else because it breaks
        things if loaded straight away.
      */
      var script = document.createElement('script');
      script.src = "<%= BASE_URL %>pyodide_dev.js";
      document.getElementsByTagName('head')[0].appendChild(script);

      function handleFile(files) {
        fetch("./headertests/__init__.py")
          .then(response => response.text())
          .then((data) => {
            pyodide.runPython(data);
            if (window.FileReader) {
              fileToRead = files[0];
              // FileReader are supported.
              var reader = new FileReader();
              // Read file into memory as UTF-8
              reader.readAsText(fileToRead);
              // Handle errors load
              reader.onload = loadHandler;
              reader.onerror = errorHandler;
            } else {
              alert('FileReader are not supported in this browser.');
            }
          });
      }

      function loadHandler(event) {
        var csv = event.target.result;
        processData(csv, "uploadFrame");
      }

      async function processData(csv, loadFrameId) {
        var allTextLines = csv.split(/\r\n|\n/);
        var lines = [];
        for (var i=0; i<allTextLines.length; i++) {
          var data = allTextLines[i].split(';');
          var tarr = [];
          for (var j=0; j<data.length; j++) {
            tarr.push(data[j]);
          }
          lines.push(tarr+'\n');
        };
        document.getElementById("uploadFrame").innerText = lines;
        pyodide.runPython(`
import pandas as pd
from js import document
csvdata = document.getElementById("uploadFrame").innerText
with open("{}.csv".format("uploadFrame") , 'w') as outfile:
     outfile.write(csvdata)
df = pd.read_csv("{}.csv".format("uploadFrame"), sep=',')
print(df)
        `);
      }

      function errorHandler(evt) {
        if(evt.target.error.name == "NotReadableError") {
          alert("Canno't read file !");
        }
      }
    </script>
  </body>
</html>
